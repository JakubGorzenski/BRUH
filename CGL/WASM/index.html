<style>
div {
    color: grey;
    font-size: 20px;
    padding-left: 10px;
}
</style>

<div id="div" style="background-color: black;">
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>

const decode = new TextDecoder("utf-8");
const encode = new TextEncoder("utf-8");

var ctx = null;
var all_files = [];
var memory = null;
var target_file = {};

var key_translation = {
    ["PrintScreen"] : 23,
    ["ScrollLock"]  : 24,
    ["Pause"] : 25,

    ["Backspace"] : 8,
    ["Tab"] : 9,
    ["Enter"] : 10,
    ["CapsLock"] : 26,
    ["Escape"] : 27,
    ["Meta"] : 28,

    [" "] : 32,

    ["!"] : 49,
    ["@"] : 50,
    ["#"] : 51,
    ["$"] : 52,
    ["%"] : 53,
    ["^"] : 54,
    ["&"] : 55,
    ["*"] : 56,
    ["("] : 57,
    [")"] : 48,

    ["_"] : 45,
    ["+"] : 43,
    ["{"] : 123,
    ["|"] : 124,
    ["}"] : 125,
    [":"] : 59,
    ["\""]: 34,
    ["<"] : 44,
    [">"] : 46,
    ["?"] : 47,

    ["Insert"] : 33,
    ["Home"] : 34,
    ["PageUp"] : 35,
    ["Delete"] : 36,
    ["End"] : 37,
    ["PageDown"] : 38,

    ["Shift"] : 0x29,
    ["Control"] : 0x2a,
    ["Alt"] : 0x2c,

    ["ArrowLeft"] : 60,
    ["ArrowRight"] : 62,
    ["ArrowUp"] : 94,
    ["ArrowDown"] : 118,

    ["NumLock"] : 39,
};

function save_target_file() {
    const data = decode.decode(target_file.data);
    window.localStorage.setItem(target_file.name, data);
    return 1;
}

var importObject = {
    internal_cgl_print(str, length) {
        var enc = new TextDecoder("utf-8");
        var str = new Int8Array(memory.buffer, str, length);
        console.log(enc.decode(str));
    },

    internal_cgl_js_init(keyboard_ptr, kbp_size) {
        for(i = 1; i <= 12; i++)    //  F1 to F12
            key_translation['F' + i] = 10 + i;
        for(i = 45; i <= 57; i++)   //  - to 9
            key_translation[String.fromCharCode(i)] = i;
        for(i = 65; i <= 93; i++)   //  A to ]
            key_translation[String.fromCharCode(i)] = i;
        for(i = 97; i <= 122; i++)   //  a to z
            key_translation[String.fromCharCode(i)] = i - 32;

        var keyboard;
        keyboard = new Int32Array(memory.buffer, keyboard_ptr, kbp_size);

        addEventListener("keydown", (event) => {
            event.preventDefault();

            if(event.repeat)
                return;
            keyboard[key_translation[event.key]] = 1;
            keyboard['?'.charCodeAt(0)] = key_translation[event.key];
            
            if(event.key.length == 1)
                keyboard['|'.charCodeAt(0)] = event.key.charCodeAt(0);
            if(event.key == "Backspace")
                keyboard['|'.charCodeAt(0)] = 8;
            if(event.key == "Tab")
                keyboard['|'.charCodeAt(0)] = 9;
            if(event.key == "Enter")
                keyboard['|'.charCodeAt(0)] = 10;
        });
        addEventListener("keyup", (event) => {
            keyboard[key_translation[event.key]] = -1;
        });
    },

    internal_cgl_file_set_target(name, length) {
        var str = new Int8Array(memory.buffer, name, length);

        target_file.name = decode.decode(str);
        target_file.data = encode.encode(window.localStorage.getItem(target_file.name));
        return target_file.data.length;
    },
    internal_cgl_file_load(buffer) {
        for(var i = 0; i < target_file.data.length; i++) {
            memory[buffer + i] = target_file.data[i];
        }
        return save_target_file();
    },
    internal_cgl_file_save(save, length) {
        target_file.data = new Int8Array(length);
        for(var i = 0; i < length; i++) {
            target_file.data[i] = memory[save + i];
        }
        return save_target_file();
    },
    internal_cgl_file_append(append, length) {
        var concat = new Uint8Array(target_file.data.length + length);
        concat.set(target_file.data);
        var app = new Uint8Array(memory.buffer, append, length);
        concat.set(app, target_file.data.length);
        target_file.data = concat;
        return save_target_file();
    },
    internal_cgl_file_delete() {
        window.localStorage.removeItem(target_file.name);
        return 1;
    },

    internal_cgl_output(buffer, w, h) {
        var cgl_screen = new ImageData(
                new Uint8ClampedArray(
                memory.subarray(buffer, buffer + w * h * 4)), w, h);
        ctx.canvas.width = w;
        ctx.canvas.height = h;
        ctx.putImageData(cgl_screen, 0, 0);
    },
};



var cgl_main;
function js_main(ms_time) {
    if(cgl_main(ms_time) != -1)
        requestAnimationFrame(js_main);
}



var pending_downloads = 0;
const div = document.getElementById("div");


function download(file, is_text) {
    div.innerHTML +=
        "<div id='" + file + "'>> " + file + "</div>";
    var request = {
        url: file,
        error: () => {
            document.getElementById(file).style.color = "red";
            document.getElementById('download').style.color = "red";
            div.innerHTML +=
                "<div style='color: red;'>\
                > ERROR: Unable to download " + file + "</div>";
        },
        success: (data) => {
            pending_downloads--;
            document.getElementById(file).style.color = "green";
            all_files[file] = data;
            start_wasm_if_all_downloads_complete();
        }
    };
    if(is_text) {
        request['dataType'] = 'text';
    } else {
        request['xhr'] = () => {
            var xhrOverride = new XMLHttpRequest();
            xhrOverride.responseType = 'arraybuffer';
            return xhrOverride;
        }
    }
    return $.when($.ajax(request));
}

function start_wasm_if_all_downloads_complete() {
    if(pending_downloads != 0)
        return;
    document.getElementById('download').style.color = "green";

    WebAssembly.instantiate(
        all_files['game.wasm'],
        { env: importObject },
    ).then((res) => {
        var old_size = res.instance.exports.memory.grow(0);
        var grow_ret = res.instance.exports.memory.grow(65536 - old_size);
        var new_size = res.instance.exports.memory.grow(0);
        console.log(old_size, grow_ret, new_size);

        memory = new Uint8Array(res.instance.exports.memory.buffer);

        res.instance.exports.internal_cgl_wasm_init(old_size, new_size - old_size);
        cgl_main = res.instance.exports._start;

        div.style.padding = 0;
        div.innerHTML =
            "<canvas id='canvas' style='height:100%; image-rendering: pixelated;'></canvas>"
        ctx = document.getElementById("canvas").getContext('2d', { alpha: false });
        requestAnimationFrame(js_main);
    });
}

div.innerHTML +=
    "<div id='download' style='font-size: 30px;'>\
    Downloading game files:</div>";

download("game.wasm");
download("file_list.txt", true).then((res) => {
    var file_list = [];
    res.split("\n").forEach((file) => {
        file = file.trim();
        if(file)
            file_list.push(file);
    });
    pending_downloads += file_list.length + 2;
    start_wasm_if_all_downloads_complete();

    file_list.forEach(file => {
        console.log(file);
        download(file);
    });
});
</script>